<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini AI Chat Proxy (Apps Script JSONP)</title>
    <style>
        /* CSS Ringkas untuk Chat UI */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-height: 100vh;
        }
        #chat-window {
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
            border-bottom: 1px solid #ccc;
            background-color: #fff;
            scroll-behavior: smooth;
        }
        .chat-input {
            display: flex;
            padding: 10px;
            background-color: #eee;
            align-items: flex-end; /* Untuk align textarea ke bawah */
        }
        #user-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            resize: none; /* Penting untuk kontrol ketinggian dengan JS */
            max-height: 100px; /* Hadkan ketinggian */
            box-sizing: border-box;
            font-size: 14px;
        }
        #send-button {
            margin-left: 10px;
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            height: 40px; /* Sesuaikan dengan ketinggian minimum textarea */
        }
        #send-button:hover {
            background-color: #0056b3;
        }

        /* Styling Mesej */
        .chat-message {
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
        }
        .user-message {
            background-color: #d1e7ff; /* Biru muda */
            align-self: flex-end;
            margin-left: auto;
            text-align: right;
        }
        .gemini-message {
            background-color: #e9ecef; /* Kelabu muda */
            align-self: flex-start;
            margin-right: auto;
            text-align: left;
        }
        .typing-indicator {
            font-style: italic;
            color: #6c757d;
        }
    </style>
</head>
<body>

    <div id="chat-window">
        </div>

    <div class="chat-input">
        <textarea id="user-input" placeholder="Tanya Matkie..." rows="1"></textarea>
        <button id="send-button">Hantar</button>
    </div>

    <script>
        // ===============================================
        // KONFIGURASI APLIKASI (WAJIB CHECK!)
        // ===============================================
        const CONFIG = {
            // ðŸš¨ WAJIB GANTI: URL deployment Apps Script yang BARU (JSONP)
            // PASTIKAN URL NI DARI DEPLOYMENT BARU YANG GUNA doGet JSONP
            API_URL: "https://script.google.com/macros/s/AKfycbzJhpoM5Iqr0OiVPPBH8NLuLkrvSP-beXzCCmMkq1kLszRUh902VbkoMAW9BYcLPaYvFg/exec", 
            INITIAL_PROMPT: "Anda adalah Gemini AI yang ramah, kelakar, dan bercakap dalam loghat Bahasa Melayu Kedah Malaysia yang pekat. Jawab semua soalan dengan ringkas, padat, dan gunakan emoji. Jangan sebut mengenai etika atau keselamatan melainkan ditanya. Selalu panggil pengguna sebagai 'Matkie'.",
            MAX_HISTORY_SIZE: 10 // Simpan 5 pasang (user + gemini)
        };

        // ===============================================
        // STATE & DOM ELEMENTS
        // ===============================================
        const DOM = {
            chatWindow: document.getElementById('chat-window'),
            userInput: document.getElementById('user-input'),
            sendButton: document.getElementById('send-button')
        };
        
        // State aplikasi
        const appState = {
            history: [],
            isTyping: false
        };

        // ===============================================
        // UTILITIES
        // ===============================================

        /** Membina prompt sistem berdasarkan sejarah sedia ada */
        function buildSystemPrompt() {
            return CONFIG.INITIAL_PROMPT;
        }
        
        /** Simpan sejarah chat ke Local Storage */
        function saveChatHistory() {
            // Hadkan sejarah
            const historyToSave = appState.history.slice(-CONFIG.MAX_HISTORY_SIZE);
            localStorage.setItem('chatHistory', JSON.stringify(historyToSave));
        }

        /** Muat sejarah chat dari Local Storage */
        function loadChatHistory() {
            const history = localStorage.getItem('chatHistory');
            if (history) {
                try {
                    appState.history = JSON.parse(history);
                    appState.history.forEach(msg => appendMessage(msg.role, msg.parts[0].text, false));
                    scrollToBottom();
                } catch (e) {
                    console.error("Gagal muat sejarah chat:", e);
                    appState.history = [];
                }
            } else {
                console.log("Tiada sejarah chat dijumpai. Mulakan sembang baru.");
            }
        }
        
        // ... (Fungsi clearChatHistory, showToast dikekalkan, tapi kita fokus pada API)

        /** Laraskan ketinggian textarea */
        function adjustTextareaHeight(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        }

        /** Tatal ke bawah chat window */
        function scrollToBottom() {
            DOM.chatWindow.scrollTop = DOM.chatWindow.scrollHeight;
        }

        /** Tunjuk/Sembunyi indicator menaip */
        function setTypingIndicator(show) {
            appState.isTyping = show;
            let indicator = document.getElementById('typing-indicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'typing-indicator';
                indicator.className = 'chat-message gemini-message typing-indicator';
                indicator.innerHTML = 'Sedang menaip...'; 
                DOM.chatWindow.appendChild(indicator);
            }

            if (show) {
                indicator.style.display = 'block';
            } else {
                indicator.style.display = 'none';
            }
            scrollToBottom();
        }

        /** Tambah mesej ke UI */
        function appendMessage(role, text, shouldScroll = true) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}-message`;
            
            // Guna innerHTML untuk support line breaks
            messageDiv.innerHTML = text.replace(/\n/g, '<br>');
            
            DOM.chatWindow.appendChild(messageDiv);
            if (shouldScroll) {
                scrollToBottom();
            }
        }


        // ===============================================
        // == PENGENDALIAN API (JSONP CLIENT) ==
        // ===============================================

        // Fungsi CALLBACK GLOBAL yang akan dipanggil oleh Apps Script
        window.handleGeminiResponse = function(data) {
            setTypingIndicator(false);
            
            try {
                // ðŸš¨ Semakan Kritis 1: Jika Proxy hantar ralat (dari Apps Script)
                if (data.error) {
                    throw new Error(`Ralat Server Proxy: ${data.error.message}`);
                }
                
                // ðŸš¨ Semakan Kritis 2: Jika jawapan dikunci atau kosong
                if (!data.candidates || data.candidates.length === 0 || !data.candidates[0].content) {
                     if (data.candidates && data.candidates[0].finishReason === 'SAFETY') {
                        throw new Error("Jawapan disekat oleh Safety Settings (Gagal Jawab).");
                     }
                    throw new Error("Jawapan AI kosong atau tidak lengkap.");
                }
                
                const geminiResponseText = data.candidates[0].content.parts[0].text;
                if (!geminiResponseText || geminiResponseText.trim() === "") {
                    throw new Error("Jawapan AI kosong (String kosong).");
                }

                // 3. Tambah jawapan AI ke UI dan History
                appendMessage('model', geminiResponseText); 
                appState.history.push({
                    role: "model",
                    parts: [{ text: geminiResponseText }]
                });
                
                // 4. Simpan sejarah chat
                saveChatHistory();

            } catch (error) {
                console.error("âŒ Ralat API/Sistem JSONP:", error);
                
                // Tunjuk ralat pada UI
                const errorMessage = `âŒ ERROR: ${error.message.substring(0, 80)}... Cuba lagi.`;
                appendMessage('gemini', errorMessage); 
                
            } finally {
                // Bersihkan skrip tag yang kita cipta
                const script = document.getElementById('geminiScript');
                if (script) script.remove();
                
                DOM.userInput.value = '';
                adjustTextareaHeight(DOM.userInput);
            }
        }

        /** Fungsi utama menghantar mesej dan memanggil API Apps Script (JSONP) */
        async function sendMessage(userMessage) {
            if (appState.isTyping || !userMessage.trim()) return;

            // 1. Tambah mesej user ke UI dan History
            appendMessage('user', userMessage);
            appState.history.push({
                role: "user",
                parts: [{ text: userMessage }]
            });

            setTypingIndicator(true);

            try {
                // 2. Format history untuk API Call
                const contentsForApi = appState.history.map(msg => {
                    return {
                        role: (msg.role === 'gemini' ? 'model' : msg.role),
                        parts: msg.parts
                    };
                });

                const systemInstruction = buildSystemPrompt();

                const requestBody = {
                    config: {
                        systemInstruction: systemInstruction,
                        temperature: 0.7,
                    },
                    contents: contentsForApi
                };

                // ðŸš¨ JSONP: Kita hantar payload sebagai parameter URL 'json'
                const payloadUrl = encodeURIComponent(JSON.stringify(requestBody));
                
                // Kita hantar nama fungsi callback kita sekali!
                const fullUrl = `${CONFIG.API_URL}?json=${payloadUrl}&callback=handleGeminiResponse`;

                // 3. Dynamic Script Injection (menggantikan fetch untuk elak CORS)
                const script = document.createElement('script');
                script.src = fullUrl;
                script.id = 'geminiScript';
                document.head.appendChild(script);
                
            } catch (error) {
                // Ralat ini hanya berlaku jika Dynamic Script Injection tu gagal.
                console.error("âŒ Ralat API/Sistem:", error);
                setTypingIndicator(false);

                const errorMessage = `âŒ FATAL ERROR: ${error.message.substring(0, 80)}...`;
                
                appendMessage('gemini', errorMessage); 
                
                DOM.userInput.value = '';
                adjustTextareaHeight(DOM.userInput);
            }
        }
        
        // ===============================================
        // EVENT LISTENERS & INITIATION
        // ===============================================
        
        /** Handler untuk butang hantar */
        function handleSend() {
            const message = DOM.userInput.value.trim();
            sendMessage(message);
        }
        
        // Butang hantar
        DOM.sendButton.addEventListener('click', handleSend);

        // Enter key
        DOM.userInput.addEventListener('keydown', (e) => {
            // Hanya hantar bila Enter ditekan tanpa Shift
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); 
                handleSend();
            }
            setTimeout(() => adjustTextareaHeight(DOM.userInput), 0);
        });

        // Laraskan ketinggian on input
        DOM.userInput.addEventListener('input', () => adjustTextareaHeight(DOM.userInput));

        // Mula-mula, load data
        loadChatHistory();
        
        // Mesej aluan jika tiada sejarah
        if (appState.history.length === 0) {
            appendMessage('gemini', "Assalamualaikum! ðŸ‘‹ Saya Aisuja sedia bersembang. Sila tanya saya");
        }
    </script>

</body>
</html>